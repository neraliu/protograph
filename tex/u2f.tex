
\documentclass[tikz,border=3mm]{standalone}
\usepackage[underline=false,roundedcorners=true]{pgf-umlsd}
\usepackage{underscore}
\usepackage{syntax}
\usepackage{hyperref}
\usetikzlibrary{shadows,positioning}
\tikzset{every shadow/.style={fill=none,shadow xshift=0pt,shadow yshift=0pt}}

%% Redefine mess for node with non-trival label, add support arrow shape
\renewcommand{\mess}[5][0]{
  \stepcounter{seqlevel}
  \path
  (#2)+(0,-\theseqlevel*\unitfactor-0.7*\unitfactor) node (mess from) {};
  \addtocounter{seqlevel}{#1}
  \path
  (#4)+(0,-\theseqlevel*\unitfactor-0.7*\unitfactor) node (mess to) {};
  \draw[#5,>=angle 60] (mess from) -- (mess to) node[midway, above]
  {#3};
}

\begin{document}

	\sffamily
	\small

    \begin{sequencediagram}
    \tikzstyle{inststyle}+=[drop shadow={opacity=0.9,fill=lightgray}]

	\def\unitfactor{1.2}
\newinst[0]{U}{U2F Device}
\newinst[6]{C}{Client}
\newinst[6]{S}{Server}
	\mess[0]{C}{HTTPS POST $u$ = USERNAME / $p$ = PASSWORD}{S}{black,->}
	\node [anchor=east] at (mess from) {};
	\node [anchor=west] at (mess to) {\shortstack[l]{1. Verify $u$ $p$ pair\\2. Generate CHALLENGE ($c$)\\3. Lookup user's public key ($K.pub$) associated by a handle ($h$)}};
	\mess[0]{S}{HTTPS $c$, $h$, APP_ID}{C}{black,->}
	\node [anchor=west] at (mess from) {};
	\node [anchor=east] at (mess to) {};
	\mess[0]{C}{Send $c$, $h$, APP_ID, $origin$, TLS_DATA}{U}{black,->}
	\node [anchor=west] at (mess from) {\shortstack[l]{1. Extract the $origin$ (aka URI)\\2. Extract TLS_DATA}};
	\node [anchor=east] at (mess to) {\shortstack[l]{1. User interacts with the device\\2. Lookup the $K.priv$ associated by APP_ID and $h$\\3. Sign the data with private key ($K.priv$)\\$sig$ = signature_by_K.priv($c$, APP_ID, $counter$, $origin$, TLS_DATA)\\$counter$ = Signature Counter}};
	\mess[0]{U}{Send $r$ = RESPONSE = $sig$, $c$, APP_ID, $counter$, $origin$, TLS_DATA}{C}{black,->}
	\node [anchor=east] at (mess from) {};
	\node [anchor=west] at (mess to) {};
	\mess[0]{C}{HTTPS POST $r$}{S}{black,->}
	\node [anchor=east] at (mess from) {};
	\node [anchor=west] at (mess to) {\shortstack[l]{1. Verify $r$ with $K.pub$\\2. Check $counter$, $origin$ and TLS_DATA}};

    \end{sequencediagram}
\end{document}
